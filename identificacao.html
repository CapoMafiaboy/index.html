<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Identificação — Tchê Pneus</title>
    <link rel="icon" type="image/png" href="images/logo.png" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        :root{--red:#d60000;--green:#009b48;--green-hover:#007a39;--bg:#f5f5f5;--text:#333}
        *{box-sizing:border-box}
        body{margin:0;font-family:Poppins,sans-serif;background:var(--bg);color:var(--text)}
        header{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .header-inner{max-width:900px;margin:0 auto;padding:14px 20px;display:flex;align-items:center}
        .brand{color:var(--red);font-weight:700;font-size:22px;cursor:pointer;transition:opacity 0.2s;text-decoration:none}
        .brand:hover{opacity:0.8}
        main{max-width:760px;margin:28px auto;padding:0 20px}
        .card{background:#fff;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.08);padding:18px}
        h2{margin:6px 0 16px;text-align:center}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1 min(320px,100%)}
        label{font-weight:600;display:block;margin:8px 0 6px}
        input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
        .btn{width:100%;border:none;border-radius:10px;padding:12px 14px;background:var(--green);color:#fff;font-weight:700;cursor:pointer}
        .btn:hover{background:var(--green-hover)}
        .error{color:var(--red);font-size:14px;margin-top:6px}
        footer{color:#666;text-align:center;padding:24px 10px}
        footer p{margin:4px 0;line-height:1.5}
    </style>
</head>
<body>
<header>
    <div class="header-inner">
        <a href="index.html" class="brand">Tchê Pneus</a>
        <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
            <a href="carrinho.html" style="text-decoration:none;color:var(--text);font-weight:600">← Voltar</a>
            <span style="color:var(--red);font-weight:700">Identificação</span>
        </div>
    </div>
</header>
<main>
    <div class="card">
        <h2>Identifique-se para continuar</h2>
        <form id="form">
            <div class="row">
                <div class="col">
                    <label for="nome">Nome*</label>
                    <input id="nome" required>
                </div>
                <div class="col">
                    <label for="sobrenome">Sobrenome*</label>
                    <input id="sobrenome" required>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label for="telefone">Número de telefone (WhatsApp)*</label>
                    <input id="telefone" placeholder="(11) 99999-9999" required>
                </div>
                <div class="col">
                    <label for="cidade">Cidade*</label>
                    <input id="cidade" required>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label for="estado">Estado*</label>
                    <select id="estado" required>
                        <option value="">Selecione</option>
                        <option>AC</option><option>AL</option><option>AP</option><option>AM</option>
                        <option>BA</option><option>CE</option><option>DF</option><option>ES</option>
                        <option>GO</option><option>MA</option><option>MT</option><option>MS</option>
                        <option>MG</option><option>PA</option><option>PB</option><option>PR</option>
                        <option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
                        <option>RS</option><option>RO</option><option>RR</option><option>SC</option>
                        <option>SP</option><option>SE</option><option>TO</option>
                    </select>
                </div>
                <div class="col">
                    <label for="cep">CEP*</label>
                    <input id="cep" placeholder="00000-000" required>
                </div>
            </div>

            <div class="row">
                <div class="col" style="flex:1 1 100%">
                    <label for="endereco">Endereço*</label>
                    <input id="endereco" placeholder="Rua, número, complemento" required>
                </div>
            </div>

            <div id="erro" class="error"></div>
            <button class="btn" type="submit">CONTINUAR</button>
        </form>
    </div>
</main>
<footer>
    <p><strong>Centro Automotivo Tchee Ltda</strong> — Tchê Pneus</p>
    <p>CNPJ: 50.311.400/0001-96 | Barueri/SP</p>
    <p>© 2023-2025 — Todos os direitos reservados</p>
</footer>
<script>
    function getCart(){ try{ return JSON.parse(localStorage.getItem('cart'))||[] }catch{ return [] } }
    const form = document.getElementById('form');
    const erro = document.getElementById('erro');
    
    // CONSTANTES DOS CAMPOS DE ENDEREÇO PARA FACILITAR A ATUALIZAÇÃO
    const cepInput    = document.getElementById('cep');
    const cidadeInput = document.getElementById('cidade');
    const estadoInput = document.getElementById('estado');
    const enderecoInput = document.getElementById('endereco');

    // FUNÇÃO PARA BUSCAR O CEP NA API VIACEP E PREENCHER OS CAMPOS
    async function buscaCep(cep) {
        const cep8 = cep.replace(/\D/g, '');
        if (cep8.length !== 8) return;

        // Limpa campos enquanto busca
        cidadeInput.value = '';
        estadoInput.value = '';
        enderecoInput.value = '';
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep8}/json/`);
            const data = await response.json();

            if (!data.erro) {
                // Preenche os campos com os dados da API
                cidadeInput.value = data.localidade || '';
                estadoInput.value = data.uf || '';
                
                // Combina logradouro e bairro para o campo Endereço
                let enderecoCompleto = '';
                if (data.logradouro) {
                    enderecoCompleto += data.logradouro;
                }
                if (data.logradouro && data.bairro) {
                    enderecoCompleto += ', ' + data.bairro;
                } else if (data.bairro) {
                    enderecoCompleto += data.bairro;
                }

                // Adiciona o complemento, se existir (ex: lado ímpar)
                if (data.complemento && data.complemento.toLowerCase() !== 'lado ímpar' && data.complemento.toLowerCase() !== 'lado par') {
                    enderecoCompleto += ' (' + data.complemento + ')';
                }
                
                enderecoInput.value = enderecoCompleto;
                
                erro.textContent = ''; 
            } else {
                erro.textContent = 'CEP não encontrado.';
            }
        } catch (e) {
            console.error("Erro ao buscar CEP:", e);
            erro.textContent = 'Erro ao consultar o CEP. Verifique sua conexão.';
        }
    }

    // 1. RECUPERA E PREENCHE O CEP DO CARRINHO
    window.addEventListener('DOMContentLoaded', () => {
        const cepSalvo = localStorage.getItem('cepFrete');
        if (cepSalvo) {
            // Formata e insere no campo
            cepInput.value = cepSalvo.replace(/(\d{5})(\d{3})/, '$1-$2'); 
            // Já consulta a API para preencher os outros campos
            buscaCep(cepSalvo); 
        }
    });

    // 2. ADICIONA EVENTO AO CAMPO CEP PARA BUSCAR NA API AO PERDER O FOCO
    cepInput.addEventListener('blur', (e) => {
        const cep = e.target.value.replace(/\D/g, '');
        if (cep.length === 8) {
            buscaCep(cep);
        } else if (cep.length > 0) {
            erro.textContent = 'CEP deve conter 8 dígitos.';
        }
    });

    form.addEventListener('submit', (e)=>{  
        e.preventDefault();  
        
        // impede seguir sem itens  
        if(getCart().length===0){ erro.textContent='Seu carrinho está vazio.'; setTimeout(()=>location.href='index.html', 1000); return; }

        const nome = document.getElementById('nome').value.trim();  
        const sobrenome = document.getElementById('sobrenome').value.trim();  
        const telefone = document.getElementById('telefone').value.trim();  
        const cidade = document.getElementById('cidade').value.trim();  
        const estado = document.getElementById('estado').value.trim();  
        const cep = document.getElementById('cep').value.trim();  
        const endereco = document.getElementById('endereco').value.trim();

        if(!nome||!sobrenome||!telefone||!cidade||!estado||!cep||!endereco){    
            erro.textContent='Preencha todos os campos obrigatórios.'; return;  
        }
        
        const cep8 = cep.replace(/\D/g,'');  
        if(cep8.length!==8){ erro.textContent='Digite um CEP válido.'; return; }

        const dados = { nome, sobrenome, telefone, cidade, estado, cep, endereco };  
        localStorage.setItem('dadosCliente', JSON.stringify(dados));  
        
        // Remove o CEP do frete após usá-lo, para não interferir em um novo pedido
        localStorage.removeItem('cepFrete'); 

        setTimeout(()=>{ window.location.href='confirmacao.html'; }, 60);
    });
</script>
</body>
</html>
